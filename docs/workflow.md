# 核心业务流程设计

## 1. 游戏加载流程

### 1.1 选择游戏卡片

- 用户从游戏卡片列表中选择想要运行的游戏
- 系统验证游戏卡片的可用性和权限
- 获取游戏卡片关联的平台信息

### 1.2 创建游戏实例

- 根据游戏卡片信息创建游戏实例申请
- 验证游戏平台的可用性
- 检查用户权限和资源配额

### 1.3 资源调度

- 平台调度器获取所有可用游戏节点的资源状态
- 根据游戏需求进行资源匹配
- 选择最优的游戏节点
- 分配必要的系统资源（CPU、内存、存储等）

### 1.4 启动游戏实例

- 在选定的游戏节点上创建游戏实例
- 初始化实例环境
- 配置网络和存储
- 设置资源限制

### 1.5 启动游戏平台

- 根据平台配置启动对应的游戏平台
- 验证平台运行状态
- 配置平台运行参数

### 1.6 配置游戏

- 下载游戏文件（如果未缓存）
- 应用游戏配置
- 设置游戏参数
- 验证游戏完整性

### 1.7 扩展业务（待实现）

#### 1.7.1 用户存档同步

- 从云存储下载用户存档
- 同步到游戏实例
- 验证存档完整性

#### 1.7.2 用户 Mods 管理

- 下载用户 Mods
- 安装并配置 Mods
- 验证 Mods 兼容性

## 2. 游戏体验模式

### 2.1 设计目标

- 吸引新用户快速了解平台能力
- 无需登录即可体验
- 限制体验时间，自动释放资源

### 2.2 体验流程

- 用户进入体验模式
- 选择体验游戏
- 系统自动创建临时游戏实例
- 开始计时（10 分钟）
- 游戏运行
- 时间到期自动释放

### 2.3 资源管理

- 使用独立的体验节点池
- 限制体验实例的资源配额
- 自动清理过期实例
- 资源使用监控

### 2.4 用户体验

- 清晰的剩余时间提示
- 简单的游戏操作界面
- 体验结束提醒
- 引导注册/登录

## 3. 游戏平台配置流程

### 3.1 平台启动/停止流程

#### 3.1.1 平台启动

- 用户点击平台列表中的"启动"按钮
- 系统创建平台实例
  - 基于平台镜像创建容器
  - 配置网络环境
  - 挂载数据卷
- 初始化平台环境
  - 加载平台系统文件
  - 设置环境变量
  - 启动必要服务
- 创建 WebRTC 会话
  - 生成唯一的会话 ID
  - 建立 WebRTC 连接
  - 配置音视频传输
- 生成平台访问链接
  - 生成带有会话 ID 的 URL
  - 设置链接有效期
  - 记录会话状态
- 平台状态更新为"运行中"
- 将访问链接显示在平台详情页中
- 用户可通过链接访问平台桌面环境进行配置

#### 3.1.2 平台配置

- 用户通过 WebRTC 链接进入平台桌面环境
- 用户进行平台配置
  - 安装/更新必要软件
  - 配置平台参数
  - 测试功能可用性
- 配置会自动保存在平台数据卷中
- 用户可随时关闭 WebRTC 会话，配置仍然保留
- 用户可多次访问同一会话继续配置

#### 3.1.3 平台停止

- 用户点击平台列表中的"停止"按钮
- 系统发送停止信号给平台实例
- 平台进行清理工作
  - 保存未保存的配置
  - 关闭正在运行的进程
  - 释放资源
- 关闭 WebRTC 会话
  - 断开所有连接
  - 清理会话资源
- 销毁平台实例
  - 保留数据卷
  - 释放计算资源
- 平台状态更新为"已停止"
- WebRTC 访问链接失效

### 3.2 权限控制

- 仅超级管理员可操作
- 记录平台配置变更日志
- 配置变更需要审核
- 支持配置回滚

### 3.3 系统数据配置

#### 3.3.1 通用配置

- 下载并解压平台系统数据
- 配置平台运行环境
- 设置平台参数
- 验证配置有效性

#### 3.3.2 平台特定配置

- Lutris：

  - 系统配置：
    - 配置 Wine 环境
    - 设置 DXVK/VKD3D
    - 配置 Python 环境
  - 用户配置：
    - 游戏启动参数
    - 显示设置
    - 音频设置

- Steam：

  - 系统配置：
    - 配置 Steam 客户端
    - 设置 Steam Play
    - 提交容器镜像（避免启动提示）
  - 用户配置：
    - 用户登录（必需）
    - 云同步设置
    - 游戏库设置
    - 好友设置
    - 控制器配置
    - 显示设置
    - 音频设置

- Nintendo Switch：
  - 系统配置：
    - 配置 Yuzu 模拟器
    - 设置控制器支持
  - 用户配置：
    - 用户提供密钥文件
    - 用户提供固件文件
    - 模拟器设置
    - 控制器映射
    - 显示设置
    - 音频设置

### 3.4 配置验证

- 验证平台功能完整性
- 检查系统数据完整性
- 测试平台启动流程
- 验证游戏兼容性

### 3.5 用户自定义配置

#### 3.5.1 配置范围

- 平台界面设置
- 游戏启动参数
- 控制器配置
- 显示设置
- 音频设置
- 网络设置

#### 3.5.2 配置存储

- 用户配置存储在用户数据目录
- 支持配置云同步
- 多设备配置同步
- 配置备份和恢复

#### 3.5.3 配置管理

- 用户可随时修改配置
- 配置实时生效
- 支持配置模板
- 配置导入导出

#### 3.5.4 权限控制

- 用户只能修改自己的配置
- 系统配置受保护
- 关键配置需要验证
- 配置修改记录

### 3.6 管理员配置流程

#### 3.6.1 Lutris 平台配置

- 环境配置：
  - 管理员点击平台"启动"按钮创建平台实例
  - 通过生成的 WebRTC 链接打开桌面环境
  - 配置 Proton 环境
  - 配置 Wine 环境
  - 配置 DXVK/VKD3D
  - 配置 Python 环境
- 系统文件生成：
  - 配置完成后生成$HOME 目录
  - 将$HOME 目录打包为 tar.xz
  - 上传至 S3 服务器
  - 更新平台配置中的 system 文件链接
- 配置验证：
  - 验证环境配置
  - 测试游戏启动
  - 确认系统文件可用性
- 实例管理：
  - 配置完成后管理员点击"停止"按钮
  - 系统关闭平台实例并保存配置

#### 3.6.2 Steam 平台配置

- 环境配置：
  - 管理员点击平台"启动"按钮创建平台实例
  - 通过生成的 WebRTC 链接打开桌面环境
  - 启动 Steam 客户端
  - 等待 Steam 更新完成
- 容器镜像管理：
  - 保存更新后的容器状态
  - 创建新的镜像版本
  - 更新平台配置中的镜像引用
- 系统文件生成：
  - 配置完成后生成$HOME 目录
  - 将$HOME 目录打包为 tar.xz
  - 上传至 S3 服务器
  - 更新平台配置中的 system 文件链接
- 配置验证：
  - 验证 Steam 客户端
  - 测试游戏启动
  - 确认系统文件可用性
- 实例管理：
  - 配置完成后管理员点击"停止"按钮
  - 系统关闭平台实例并保存配置

#### 3.6.3 Nintendo Switch 平台配置

- 环境配置：
  - 管理员点击平台"启动"按钮创建平台实例
  - 通过生成的 WebRTC 链接打开桌面环境
  - 配置 Yuzu 模拟器
  - 设置控制器支持
  - 配置显示和音频
- 配置验证：
  - 验证模拟器功能
  - 测试游戏兼容性
  - 确认控制器支持
- 实例管理：
  - 配置完成后管理员点击"停止"按钮
  - 系统关闭平台实例并保存配置

### 3.7 用户配置流程

#### 3.7.1 Lutris 用户配置

- 配置范围：
  - 游戏启动参数
  - 显示设置
  - 音频设置
  - 控制器配置
- 配置方式：
  - 用户点击平台"启动"按钮
  - 通过生成的 WebRTC 链接访问桌面环境
  - 直接修改配置文件或使用配置界面
  - 配置完成后点击"停止"按钮

#### 3.7.2 Steam 用户配置

- 必需配置：
  - 用户点击平台"启动"按钮
  - 通过生成的 WebRTC 链接访问桌面环境
  - 用户登录（通过 WebRTC 桌面环境）
  - Steam Play 设置
- 可选配置：
  - 云同步设置
  - 游戏库设置
  - 好友设置
  - 控制器配置
  - 显示设置
  - 音频设置
- 配置保存：
  - 自动保存用户配置
  - 生成新的用户系统文件
  - 更新用户配置记录
- 实例管理：
  - 配置完成后用户点击"停止"按钮
  - 系统关闭平台实例并保存配置

### 3.8 配置存储管理

#### 3.8.1 系统文件存储

- 存储位置：S3 服务器
- 文件格式：tar.xz
- 版本控制：
  - 系统文件版本管理
  - 更新历史记录
  - 回滚支持
- 访问控制：
  - 只读访问
  - 下载权限控制
  - 缓存策略

#### 3.8.2 用户配置存储

- 存储位置：用户数据目录
- 文件格式：JSON/YAML
- 同步机制：
  - 实时同步
  - 冲突处理
  - 备份恢复
- 访问控制：
  - 用户权限控制
  - 读写权限管理
  - 配置保护

### 3.9 平台访问链接管理

#### 3.9.1 链接生成

- 链接生成时机：
  - 平台启动成功后自动生成
  - 平台重启后更新链接
- 链接格式：
  - 包含会话 ID 和安全令牌
  - 使用 HTTPS 协议
  - 使用短 URL 形式便于分享

#### 3.9.2 链接展示

- 平台详情页面：
  - 在平台详情页中添加"远程访问"区域
  - 显示当前活动链接及状态
  - 提供一键复制功能
- 平台列表页面：
  - 在操作列中添加"访问"按钮（仅当平台运行时显示）
  - 点击即可直接访问平台
- 通知机制：
  - 平台启动完成后发送通知
  - 通知中包含访问链接

#### 3.9.3 链接安全

- 访问控制：
  - 链接设置有效期（默认 24 小时）
  - 支持手动刷新链接
  - 平台停止时自动失效
- 权限管理：
  - 根据用户角色限制访问权限
  - 管理员可查看所有平台链接
  - 普通用户只能访问自己的平台链接
- 监控与审计：
  - 记录所有链接访问日志
  - 监控异常访问行为
  - 支持手动终止可疑会话
